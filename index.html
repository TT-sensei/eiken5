<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±æ¤œ5ç´š 60å•ãƒãƒ£ãƒ¬ãƒ³ã‚¸å®Œå…¨ç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #4fc3f7; /* æ¸…æ½”æ„Ÿã®ã‚ã‚‹ç©ºè‰² */
            --success: #81c784; /* å„ªã—ã„ã‚°ãƒªãƒ¼ãƒ³ */
            --wrong: #ff8a65; /* è½ã¡ç€ã„ãŸã‚ªãƒ¬ãƒ³ã‚¸ãƒ¬ãƒƒãƒ‰ */
            --bg: #f0f4f8; 
            --accent: #ffd54f; 
            --text: #455a64;
        }
        body { 
            font-family: 'Kosugi Maru', sans-serif; 
            background: var(--bg); 
            text-align: center; 
            margin: 0; 
            padding: 10px; 
            color: var(--text);
        }
        #app { 
            max-width: 550px; 
            margin: 20px auto; 
            background: white; 
            padding: 25px; 
            border-radius: 30px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); 
            min-height: 480px; 
            position: relative;
            border: 4px solid #cfd8dc;
        }
        h1 { color: var(--primary); font-size: 26px; margin-bottom: 5px; }
        
        .btn { 
            display: block; width: 100%; margin: 15px 0; padding: 18px; 
            font-size: 19px; border-radius: 20px; 
            border: 2px solid #eceff1; background: white; 
            cursor: pointer; touch-action: manipulation; user-select: none; 
            transition: all 0.2s; color: var(--text);
            box-shadow: 0 4px 0 #cfd8dc;
        }
        .btn:hover { background: #fdfdfd; border-color: var(--primary); }
        .btn.selected { 
            background: var(--accent); border-color: #fbc02d; 
            transform: translateY(2px); box-shadow: 0 2px 0 #fbc02d;
        }
        .btn:active { transform: translateY(4px); box-shadow: none; }

        .small-btn { padding: 10px 18px; font-size: 14px; width: auto; display: inline-block; margin: 5px; border-radius: 15px; }
        .hidden { display: none; }

        #mark { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); font-size: 220px; opacity: 0; pointer-events: none; z-index: 100; }
        .mark-ani { animation: pop 0.8s ease-out; }
        @keyframes pop { 0%{opacity:0; transform:translate(-50%,-50%) scale(0.3);} 30%{opacity:1;} 100%{opacity:0; transform:translate(-50%,-50%) scale(1.3);} }

        .q-text { font-size: 24px; font-weight: bold; margin: 25px 0; color: #37474f; line-height: 1.5; }
        
        .stamp-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin: 20px 0; }
        .stamp { 
            background: #fff9e6; border: 2px dashed var(--accent); border-radius: 15px;
            width: 60px; height: 60px; display: flex; align-items: center; 
            justify-content: center; font-size: 28px; 
        }

        .review-area { text-align: left; background: #fafafa; padding: 20px; border-radius: 20px; margin-top: 25px; border: 2px solid #eee; }
        .review-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; }
        .review-q { color: var(--wrong); font-weight: bold; display: block; font-size: 1.1em; }
        .review-a { color: var(--success); font-size: 0.95em; display: block; margin-top: 6px; }
    </style>
</head>
<body>

<div id="app">
    <div style="text-align:right;">
        <button onclick="toggleSound()" class="small-btn btn" id="soundBtn" style="background:#fff; color:var(--primary);">ğŸ”Š éŸ³ON</button>
    </div>

    <div id="view-start">
        <h1>ğŸŒŸ è‹±æ¤œ5ç´š 60å•ãƒ†ã‚¹ãƒˆ ğŸš€</h1>
        <p style="font-size:15px; color:#78909c;">10å•ãƒ©ãƒ³ãƒ€ãƒ ã«å‡ºé¡Œï¼<br>é¸ã‚“ã ã‚ã¨ã€ã‚‚ã†ä¸€å›æŠ¼ã™ã¨æ±ºå®šã ã‚ˆ</p>
        <button onclick="startQuiz()" class="btn" style="background:var(--success); color:white; border:none; font-weight:bold; font-size:24px; box-shadow: 0 6px 0 #689f38;">ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>
        <div style="margin-top:30px;">
            <p style="font-size:14px; font-weight:bold; color:var(--text);">ğŸ† ã‚ã¤ã‚ãŸã‚¹ã‚¿ãƒ³ãƒ— ğŸ†</p>
            <div id="saved-stamps" class="stamp-grid"></div>
            <button onclick="resetStamps()" class="small-btn btn" style="background:#cfd8dc; color:#fff; border:none; box-shadow: 0 3px 0 #b0bec5;">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
    </div>

    <div id="view-quiz" class="hidden">
        <div id="q-header" style="font-size:15px; color:#90a4ae; font-weight:bold;"></div>
        <div id="q-body" class="q-text"></div>
        <div id="options"></div>
    </div>

    <div id="view-result" class="hidden">
        <h1>âœ¨ çµæœç™ºè¡¨ âœ¨</h1>
        <h2 id="score-text" style="font-size:42px; color:var(--primary); margin: 15px 0;"></h2>
        <div id="new-stamps-container">
            <p style="font-size:15px; font-weight:bold; color:var(--text);">ğŸ‰ ã‚²ãƒƒãƒˆã—ãŸã‚¹ã‚¿ãƒ³ãƒ—</p>
            <div id="new-stamps" class="stamp-grid"></div>
        </div>
        <div id="review-area" class="review-area hidden">
            <p style="margin:0 0 10px 0; font-weight:bold; color:#546e7a;">ğŸ“ å¾©ç¿’ãƒªã‚¹ãƒˆ</p>
            <div id="review-list"></div>
        </div>
        <button onclick="location.reload()" class="btn" style="background:var(--primary); color:white; border:none; box-shadow: 0 6px 0 #0288d1;">ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦</button>
    </div>
</div>

<div id="mark"></div>

<script>
const QUESTIONS = [
    {"question":"How are you?","options":["I'm fine.","Thank you.","Goodbye.","Yes, please."],"answer":0,"stamp":"ğŸ˜Š"},
    {"question":"Nice to meet you.","options":["Nice to meet you, too.","You're welcome.","No, thank you.","I'm sorry."],"answer":0,"stamp":"ğŸ¤"},
    {"question":"I ( ) to school every day.","options":["goes","go","going","gone"],"answer":1,"stamp":"ğŸ«"},
    {"question":"Can you ( ) the piano?","options":["plays","playing","play","played"],"answer":2,"stamp":"ğŸ¹"},
    {"question":"( ) is that boy? --- He is my brother.","options":["What","Where","Who","How"],"answer":2,"stamp":"ğŸ‘¦"},
    {"question":"This is ( ) notebook.","options":["my","me","I","mine"],"answer":0,"stamp":"ğŸ““"},
    {"question":"I am ( ) music now.","options":["listen","listening","listens","listened"],"answer":1,"stamp":"ğŸ§"},
    {"question":"I like ( ) very much.","options":["apple","an apple","apples","the apple"],"answer":2,"stamp":"ğŸ"},
    {"question":"Let's ( ) tennis.","options":["play","playing","plays","to play"],"answer":0,"stamp":"ğŸ¾"},
    {"question":"Look ( ) the picture.","options":["to","at","in","for"],"answer":1,"stamp":"ğŸ–¼ï¸"},
    {"question":"( ) time is it?","options":["How","What","When","Where"],"answer":1,"stamp":"â°"},
    {"question":"( ) old are you?","options":["How","What","Who","Where"],"answer":0,"stamp":"ğŸ‚"},
    {"question":"I ( ) breakfast at seven.","options":["have","has","having","to have"],"answer":0,"stamp":"ğŸ"},
    {"question":"My father ( ) tennis on Sundays.","options":["play","plays","playing","played"],"answer":1,"stamp":"ğŸ¾"},
    {"question":"( ) you help me?","options":["Do","Can","Are","Is"],"answer":1,"stamp":"ğŸ†˜"},
    {"question":"( ) is the station?","options":["Who","Where","When","What"],"answer":1,"stamp":"ğŸš‰"},
    {"question":"( ) do you play soccer? --- In the park.","options":["When","Who","Where","What"],"answer":2,"stamp":"ğŸŒ³"},
    {"question":"( ) name is Ken.","options":["He","His","Him","He's"],"answer":1,"stamp":"ğŸ†”"},
    {"question":"Look at ( ).","options":["we","our","us","ours"],"answer":2,"stamp":"ğŸ‘€"},
    {"question":"They are ( ) in the pool.","options":["swim","swimming","swims","swam"],"answer":1,"stamp":"ğŸŠ"},
    {"question":"I ( ) like baseball.","options":["am not","don't","doesn't","not"],"answer":1,"stamp":"âš¾"},
    {"question":"She ( ) English every day.","options":["study","studies","studying","to study"],"answer":1,"stamp":"âœï¸"},
    {"question":"How ( ) is this? --- It's 100 yen.","options":["much","many","old","long"],"answer":0,"stamp":"ğŸ’°"},
    {"question":"( ) is your birthday?","options":["What","When","Where","Who"],"answer":1,"stamp":"ğŸ“…"},
    {"question":"I ( ) a new car.","options":["want","wants","wanting","to want"],"answer":0,"stamp":"ğŸš—"},
    {"question":"It is ( ) today.","options":["sun","sunny","suns","sunned"],"answer":1,"stamp":"â˜€ï¸"},
    {"question":"What ( ) you doing?","options":["am","is","are","do"],"answer":2,"stamp":"â“"},
    {"question":"( ) up, Ken. It's seven o'clock.","options":["Get","Go","Take","Sit"],"answer":0,"stamp":"ğŸŒ"},
    {"question":"Open ( ) book, please.","options":["you","your","me","mine"],"answer":1,"stamp":"ğŸ“–"},
    {"question":"I ( ) a student.","options":["is","am","are","be"],"answer":1,"stamp":"ğŸ’"},
    {"question":"This is an ( ).","options":["pen","book","orange","desk"],"answer":2,"stamp":"ğŸŠ"},
    {"question":"Are you ( )? --- Yes, I am.","options":["cook","cooking","cooks","to cook"],"answer":1,"stamp":"ğŸ³"},
    {"question":"( ) many books do you have?","options":["How","What","When","Where"],"answer":0,"stamp":"ğŸ“š"},
    {"question":"I play soccer ( ) Saturday.","options":["in","on","at","to"],"answer":1,"stamp":"âš½"},
    {"question":"He ( ) a tall boy.","options":["am","is","are","do"],"answer":1,"stamp":"ğŸ¦’"},
    {"question":"( ) go to the library.","options":["Let's","Do","Are","Is"],"answer":0,"stamp":"ğŸ›ï¸"},
    {"question":"Whose bag is ( )?","options":["this","these","those","my"],"answer":0,"stamp":"ğŸ’¼"},
    {"question":"Good ( ), Mom. --- Good night, Ken.","options":["morning","evening","night","afternoon"],"answer":2,"stamp":"ğŸŒ™"},
    {"question":"( ) you busy?","options":["Do","Are","Can","Is"],"answer":1,"stamp":"ğŸƒ"},
    {"question":"I am ( ) from Canada.","options":["no","not","don't","isn't"],"answer":1,"stamp":"ğŸ‡¨ğŸ‡¦"},
    {"question":"( ) close the door.","options":["Not","No","Don't","Doesn't"],"answer":2,"stamp":"ğŸšª"},
    {"question":"That ( ) is mine.","options":["pen","pens","pen's","a pen"],"answer":0,"stamp":"âœ’ï¸"},
    {"question":"We ( ) lunch at school.","options":["eat","eats","eating","to eat"],"answer":0,"stamp":"ğŸ±"},
    {"question":"I like ( ) music.","options":["listen","listening to","listen to","listens"],"answer":1,"stamp":"ğŸµ"},
    {"question":"Wait ( ) me, please.","options":["at","to","for","in"],"answer":2,"stamp":"âŒ›"},
    {"question":"How ( ) do you go there? --- Twice a week.","options":["often","much","many","old"],"answer":0,"stamp":"ğŸ”„"},
    {"question":"Excuse ( ).","options":["me","I","my","mine"],"answer":0,"stamp":"ğŸ’¬"},
    {"question":"Happy ( ) Year!","options":["New","Now","Good","Nice"],"answer":0,"stamp":"ğŸ"},
    {"question":"I'm ( ). --- Here is some water.","options":["hungry","thirsty","sleepy","happy"],"answer":1,"stamp":"ğŸ’§"},
    {"question":"( ) your name?","options":["What","What's","How's","Who's"],"answer":1,"stamp":"ğŸ“"},
    {"question":"( ) your hands.","options":["Wash","Watch","Walk","Wait"],"answer":0,"stamp":"ğŸ§¼"},
    {"question":"This is for ( ).","options":["you","your","yours","you're"],"answer":0,"stamp":"ğŸ"},
    {"question":"( ) me a favor?","options":["Do","Make","Give","Take"],"answer":0,"stamp":"ğŸ™"},
    {"question":"I ( ) the piano every day.","options":["play","plays","playing","played"],"answer":0,"stamp":"ğŸ¹"},
    {"question":"Do you like ( )?","options":["apple","apples","an apple","the apple"],"answer":1,"stamp":"ğŸ"},
    {"question":"( ) you like coffee?","options":["Do","Are","Is","Can"],"answer":0,"stamp":"â˜•"},
    {"question":"See you ( ).","options":["again","ready","well","nice"],"answer":0,"stamp":"ğŸ‘‹"},
    {"question":"I have ( ) breakfast.","options":["a","an","the","(no word)"],"answer":3,"stamp":"ğŸ½ï¸"},
    {"question":"Please ( ) here.","options":["come","comes","coming","to come"],"answer":0,"stamp":"ğŸ“"},
    {"question":"( ) is that? --- It's a camera.","options":["What","Who","Where","How"],"answer":0,"stamp":"ğŸ“·"}
];

let quizSet=[], current=0, score=0, wrongAnswers=[], newlyEarnedStamps=[], selectedIndex=null;
let soundOn=true, audioCtx=null;

window.onload = displaySavedStamps;

function toggleSound() {
    soundOn = !soundOn;
    document.getElementById("soundBtn").textContent = soundOn ? "ğŸ”Š éŸ³ON" : "ğŸ”‡ éŸ³OFF";
    if(!soundOn) window.speechSynthesis.cancel();
}

function displaySavedStamps() {
    const saved = JSON.parse(localStorage.getItem('eiken5_stamps') || '[]');
    const container = document.getElementById('saved-stamps');
    container.innerHTML = "";
    saved.forEach(s => {
        const div = document.createElement('div');
        div.className = 'stamp'; div.textContent = s; container.appendChild(div);
    });
}

function resetStamps() {
    if(confirm("ã‚ã¤ã‚ãŸã‚¹ã‚¿ãƒ³ãƒ—ã‚’æ¶ˆã—ã¾ã™ã‹ï¼Ÿ")) {
        localStorage.removeItem("eiken5_stamps");
        displaySavedStamps();
    }
}

function startQuiz() {
    if(!audioCtx) audioCtx = new(window.AudioContext || window.webkitAudioContext)();
    quizSet = [...QUESTIONS].sort(() => 0.5 - Math.random()).slice(0, 10);
    current=0; score=0; wrongAnswers=[]; newlyEarnedStamps=[];
    document.getElementById('view-start').classList.add('hidden');
    document.getElementById('view-quiz').classList.remove('hidden');
    showQuestion();
}

function showQuestion() {
    selectedIndex = null;
    let originalQ = quizSet[current];

    // é¸æŠè‚¢ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
    let options = originalQ.options.map((opt, index) => ({
        text: opt,
        isCorrect: index === originalQ.answer
    }));
    options.sort(() => 0.5 - Math.random());

    let newAnswerIndex = options.findIndex(o => o.isCorrect);

    quizSet[current] = {
        ...originalQ,
        options: options.map(o => o.text),
        answer: newAnswerIndex
    };

    let q = quizSet[current];
    document.getElementById('q-header').textContent = `ç¬¬ ${current + 1} å• / 10`;
    document.getElementById('q-body').textContent = q.question;

    let html = "";
    q.options.forEach((opt, i) => {
        html += `<button class="btn" id="opt${i}" onclick="handleSelect(${i})">${opt}</button>`;
    });
    document.getElementById('options').innerHTML = html;

    speak(q.question);
}

function handleSelect(i) {
    if (selectedIndex === i) {
        submitAnswer(i);
    } else {
        selectedIndex = i;
        document.querySelectorAll('.btn').forEach(b => b.classList.remove('selected'));
        document.getElementById(`opt${i}`).classList.add('selected');
        speak(quizSet[current].options[i]);
    }
}

function submitAnswer(i) {
    let q = quizSet[current];
    let correct = (i === q.answer);
    playSound(correct);
    showMark(correct);
    if(correct) {
        score++;
        saveStamp(q.stamp);
    } else {
        wrongAnswers.push(q);
    }
    current++;
    setTimeout(() => {
        if(current < quizSet.length) showQuestion();
        else showScore();
    }, 800);
}

function saveStamp(s) {
    let saved = JSON.parse(localStorage.getItem('eiken5_stamps') || '[]');
    if(!saved.includes(s)) {
        saved.push(s);
        localStorage.setItem('eiken5_stamps', JSON.stringify(saved));
        newlyEarnedStamps.push(s);
    }
}

function showMark(correct) {
    const m = document.getElementById('mark');
    m.textContent = correct ? "â—¯" : "Ã—";
    m.style.color = correct ? "var(--success)" : "var(--wrong)";
    m.className = "mark-ani";
    setTimeout(() => m.className = "", 800);
}

function showScore() {
    document.getElementById('view-quiz').classList.add('hidden');
    document.getElementById('view-result').classList.remove('hidden');
    document.getElementById('score-text').textContent = `${score} / 10 ç‚¹`;
    
    const newStampDiv = document.getElementById('new-stamps');
    newStampDiv.innerHTML = "";
    if(newlyEarnedStamps.length > 0) {
        newlyEarnedStamps.forEach(s => {
            const div = document.createElement('div');
            div.className = 'stamp'; div.textContent = s; newStampDiv.appendChild(div);
        });
    }

    const rList = document.getElementById('review-list');
    rList.innerHTML = "";
    if(wrongAnswers.length > 0) {
        document.getElementById('review-area').classList.remove('hidden');
        wrongAnswers.forEach(q => {
            const div = document.createElement('div');
            div.className = 'review-item';
            div.innerHTML = `<span class="review-q">${q.question}</span><span class="review-a">ã›ã„ã‹ã„ï¼š${q.options[q.answer]}</span>`;
            div.onclick = () => speak(q.question.replace("( )", q.options[q.answer]));
            rList.appendChild(div);
        });
    }
}

function speak(text) {
    if(!soundOn) return;
    window.speechSynthesis.cancel();

    // å¤§æ–‡å­—Iã‚’æ­£ã—ãèª­ã¾ã›ã‚‹ãŸã‚ã®å¯¾ç­–
    let processedText = text.replace(/\bI\b/g, " I ");

    if(processedText.includes("( )")){
        // ç©ºç™½ã‚’å…¥ã‚Œã¦è‡ªç„¶ãªé–“ã‚’ä½œã‚‹
        const naturalText = processedText.replace("( )", "      "); 
        const u = new SpeechSynthesisUtterance(naturalText);
        u.lang = "en-US";
        u.rate = 0.85;
        speechSynthesis.speak(u);
    } else {
        const u = new SpeechSynthesisUtterance(processedText);
        u.lang = "en-US";
        u.rate = 0.85;
        speechSynthesis.speak(u);
    }
}

function playSound(correct) {
    if(!soundOn || !audioCtx) return;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.frequency.setValueAtTime(correct ? 880 : 220, audioCtx.currentTime);
    if(correct) osc.frequency.exponentialRampToValueAtTime(1320, audioCtx.currentTime + 0.1);
    gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
    osc.start(); osc.stop(audioCtx.currentTime + 0.3);
}
</script>
</body>
</html>
