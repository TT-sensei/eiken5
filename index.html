<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±æ¤œ5ç´š å®Œç’§ãƒã‚¹ã‚¿ãƒ¼</title>
    <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&family=Lexend:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #4fc3f7; --success: #81c784; --wrong: #ff8a65; 
            --bg: #f0f4f8; --accent: #ffd54f; --text: #455a64;
        }
        body { font-family: 'Lexend', 'Kosugi Maru', sans-serif; background: var(--bg); text-align: center; margin: 0; padding: 10px; color: var(--text); }
        #app { max-width: 550px; margin: 20px auto; background: white; padding: 25px; border-radius: 30px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); min-height: 500px; position: relative; border: 4px solid #cfd8dc; }
        h1 { color: var(--primary); font-size: 24px; margin-bottom: 20px; }
        .btn { display: block; width: 100%; margin: 12px 0; padding: 16px; font-size: 18px; border-radius: 20px; border: 2px solid #eceff1; background: white; cursor: pointer; touch-action: manipulation; user-select: none; transition: all 0.2s; color: var(--text); box-shadow: 0 4px 0 #cfd8dc; }
        .btn:hover { border-color: var(--primary); }
        .btn.selected { background: var(--accent); border-color: #fbc02d; transform: translateY(2px); box-shadow: 0 2px 0 #fbc02d; }
        .mode-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .mode-btn { padding: 15px 5px; font-size: 14px; background: #fff; border: 2px solid #eee; border-radius: 15px; cursor: pointer; color: var(--text); box-shadow: 0 3px 0 #eee; }
        .test-btn { background: var(--success); color: white; border: none; font-weight: bold; font-size: 20px; box-shadow: 0 5px 0 #689f38; }
        .hidden { display: none; }
        #mark { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); font-size: 220px; opacity: 0; pointer-events: none; z-index: 100; }
        .mark-ani { animation: pop 0.8s ease-out; }
        @keyframes pop { 0%{opacity:0; transform:translate(-50%,-50%) scale(0.3);} 30%{opacity:1;} 100%{opacity:0; transform:translate(-50%,-50%) scale(1.3);} }
        .q-text { font-size: 24px; font-weight: bold; margin: 25px 0; color: #37474f; line-height: 1.4; }
        
        .stamp-book { background: #fff9e6; padding: 15px; border-radius: 20px; border: 2px dashed var(--accent); margin-top: 15px; }
        .stamp-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin: 10px 0; }
        .stamp { background: white; border: 1px solid #ffe082; border-radius: 12px; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; font-size: 22px; }
        .special-stamps { display: flex; justify-content: center; gap: 20px; margin-top: 10px; font-weight: bold; color: #ffa000; }
        .special-item { font-size: 18px; }
        .review-area { text-align: left; background: #fafafa; padding: 15px; border-radius: 20px; margin-top: 20px; border: 2px solid #eee; }
        .review-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
    </style>
</head>
<body>

<div id="app">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <span id="current-mode-label" style="font-size:12px; color:var(--primary); font-weight:bold;"></span>
        <button onclick="toggleSound()" class="mode-btn" id="soundBtn" style="width:80px; padding:5px;">ğŸ”Š éŸ³ON</button>
    </div>

    <div id="view-start">
        <h1>ğŸŒŸ è‹±æ¤œ5ç´š ç·´ç¿’ãƒ«ãƒ¼ãƒ  ğŸš€</h1>
        <p style="font-size:14px; margin-bottom:10px; color:#90a4ae;">ã‚³ãƒ¼ã‚¹ã‚’ãˆã‚‰ã‚“ã§ç·´ç¿’ï¼ˆ5å•ï¼‰</p>
        <div class="mode-grid">
            <button class="mode-btn" onclick="startQuiz('A')">ğŸ˜Š ä¼šè©±ãƒ»æŒ¨æ‹¶</button>
            <button class="mode-btn" onclick="startQuiz('B')">â“ ç–‘å•æ–‡</button>
            <button class="mode-btn" onclick="startQuiz('C')">ğŸƒ å‹•ããƒ»å‘½ä»¤</button>
            <button class="mode-btn" onclick="startQuiz('D')">âš™ï¸ æ–‡æ³•ãƒ«ãƒ¼ãƒ«</button>
        </div>
        <p style="font-size:14px; margin-bottom:10px; color:#90a4ae;">ãœã‚“ã¶ã‹ã‚‰åŠ›ã ã‚ã—ï¼ˆ10å•ï¼‰</p>
        <button class="btn test-btn" onclick="startQuiz('ALL')">ğŸ† å…¨ç¯„å›²ãƒ†ã‚¹ãƒˆ</button>

        <div class="stamp-book">
            <p style="font-size:13px; font-weight:bold; margin:0;">ğŸ† ã‚¹ã‚¿ãƒ³ãƒ—å¸³ ğŸ†</p>
            <div id="saved-stamps" class="stamp-grid"></div>
            <div class="special-stamps">
                <div class="special-item">ğŸ’®åˆæ ¼: <span id="pass-count">0</span></div>
                <div class="special-item">ğŸ‘‘æº€ç‚¹: <span id="perfect-count">0</span></div>
            </div>
            <button onclick="resetStamps()" style="font-size:11px; border:none; background:none; color:#bbb; text-decoration:underline; cursor:pointer; margin-top:10px;">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
    </div>

    <div id="view-quiz" class="hidden">
        <div id="q-header" style="font-size:14px; color:#90a4ae; font-weight:bold;"></div>
        <div id="q-body" class="q-text"></div>
        <div id="options"></div>
    </div>

    <div id="view-result" class="hidden">
        <h1 id="result-title">âœ¨ çµæœç™ºè¡¨ âœ¨</h1>
        <h2 id="score-text" style="font-size:42px; color:var(--primary); margin: 10px 0;"></h2>
        <div id="reward-message" style="margin: 20px 0; font-weight: bold;"></div>
        <div id="review-area" class="review-area hidden">
            <p style="margin:0 0 10px 0; font-weight:bold; font-size:13px;">ğŸ“ ãµãã—ã‚…ã†ãƒªã‚¹ãƒˆ</p>
            <div id="review-list"></div>
        </div>
        <button onclick="location.reload()" class="btn test-btn">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸ã‚‚ã©ã‚‹</button>
    </div>
</div>

<div id="mark"></div>

<script>
// ãƒ‡ãƒ¼ã‚¿çœç•¥ã›ãšå…¨æ–‡æ²è¼‰
const QUESTIONS = [
    {cat:"A", q:"How are you?", opts:["I'm fine.","Thank you.","Goodbye.","Yes, please."], ans:0, s:"ğŸ˜Š"},
    {cat:"A", q:"Nice to meet you.", opts:["Nice to meet you, too.","You're welcome.","No, thank you.","I'm sorry."], ans:0, s:"ğŸ¤"},
    {cat:"A", q:"Good ( ), Mom. --- Good night, Ken.", opts:["morning","evening","night","afternoon"], ans:2, s:"ğŸŒ™"},
    {cat:"A", q:"Excuse ( ).", opts:["me","I","my","mine"], ans:0, s:"ğŸ’¬"},
    {cat:"A", q:"Happy ( ) Year!", opts:["New","Now","Good","Nice"], ans:0, s:"ğŸ"},
    {cat:"A", q:"See you ( ).", opts:["again","ready","well","nice"], ans:0, s:"ğŸ‘‹"},
    {cat:"A", q:"( ) me a favor?", opts:["Do","Make","Give","Take"], ans:0, s:"ğŸ™"},
    {cat:"A", q:"( ) up, Ken. It's seven o'clock.", opts:["Get","Go","Take","Sit"], ans:0, s:"ğŸŒ"},
    {cat:"A", q:"( ) your name?", opts:["What","What's","How's","Who's"], ans:1, s:"ğŸ“"},
    {cat:"A", q:"I'm ( ). --- Here is some water.", opts:["hungry","thirsty","sleepy","happy"], ans:1, s:"ğŸ’§"},
    {cat:"A", q:"This is for ( ).", opts:["you","your","yours","you're"], ans:0, s:"ğŸ"},
    {cat:"A", q:"Open ( ) book, please.", opts:["you","your","me","mine"], ans:1, s:"ğŸ“–"},
    {cat:"A", q:"Please ( ) here.", opts:["come","comes","coming","to come"], ans:0, s:"ğŸ“"},
    {cat:"A", q:"Wait ( ) me, please.", opts:["at","to","for","in"], ans:2, s:"âŒ›"},
    {cat:"A", q:"( ) you busy?", opts:["Do","Are","Can","Is"], ans:1, s:"ğŸƒ"},
    {cat:"B", q:"( ) time is it?", opts:["How","What","When","Where"], ans:1, s:"â°"},
    {cat:"B", q:"( ) old are you?", opts:["How","What","Who","Where"], ans:0, s:"ğŸ‚"},
    {cat:"B", q:"( ) is that boy? --- He is my brother.", opts:["What","Where","Who","How"], ans:2, s:"ğŸ‘¦"},
    {cat:"B", q:"( ) is the station?", opts:["Who","Where","When","What"], ans:1, s:"ğŸš‰"},
    {cat:"B", q:"( ) do you play soccer? --- In the park.", opts:["When","Who","Where","What"], ans:2, s:"ğŸŒ³"},
    {cat:"B", q:"How ( ) is this? --- It's 100 yen.", opts:["much","many","old","long"], ans:0, s:"ğŸ’°"},
    {cat:"B", q:"( ) is your birthday?", opts:["What","When","Where","Who"], ans:1, s:"ğŸ“…"},
    {cat:"B", q:"What ( ) you doing?", opts:["am","is","are","do"], ans:2, s:"â“"},
    {cat:"B", q:"( ) many books do you have?", opts:["How","What","When","Where"], ans:0, s:"ğŸ“š"},
    {cat:"B", q:"( ) you like coffee?", opts:["Do","Are","Is","Can"], ans:0, s:"â˜•"},
    {cat:"B", q:"( ) is that? --- It's a camera.", opts:["What","Who","Where","How"], ans:0, s:"ğŸ“·"},
    {cat:"B", q:"Whose bag is ( )?", opts:["this","these","those","my"], ans:0, s:"ğŸ’¼"},
    {cat:"B", q:"How ( ) do you go there? --- Twice a week.", opts:["often","much","many","old"], ans:0, s:"ğŸ”„"},
    {cat:"B", q:"Are you ( )? --- Yes, I am.", opts:["cook","cooking","cooks","to cook"], ans:1, s:"ğŸ³"},
    {cat:"B", q:"( ) you help me?", opts:["Do","Can","Are","Is"], ans:1, s:"ğŸ†˜"},
    {cat:"C", q:"I ( ) to school every day.", opts:["goes","go","going","gone"], ans:1, s:"ğŸ«"},
    {cat:"C", q:"I ( ) breakfast at seven.", opts:["have","has","having","to have"], ans:0, s:"ğŸ"},
    {cat:"C", q:"( ) your hands.", opts:["Wash","Watch","Walk","Wait"], ans:0, s:"ğŸ§¼"},
    {cat:"C", q:"My father ( ) tennis on Sundays.", opts:["play","plays","playing","played"], ans:1, s:"ğŸ¾"},
    {cat:"C", q:"Look ( ) the picture.", opts:["to","at","in","for"], ans:1, s:"ğŸ–¼ï¸"},
    {cat:"C", q:"Let's ( ) tennis.", opts:["play","playing","plays","to play"], ans:0, s:"ğŸ¾"},
    {cat:"C", q:"We ( ) lunch at school.", opts:["eat","eats","eating","to eat"], ans:0, s:"ğŸ±"},
    {cat:"C", q:"They are ( ) in the pool.", opts:["swim","swimming","swims","swam"], ans:1, s:"ğŸŠ"},
    {cat:"C", q:"I ( ) the piano every day.", opts:["play","plays","playing","played"], ans:0, s:"ğŸ¹"},
    {cat:"C", q:"She ( ) English every day.", opts:["study","studies","studying","to study"], ans:1, s:"âœï¸"},
    {cat:"C", q:"I play soccer ( ) Saturday.", opts:["in","on","at","to"], ans:1, s:"âš½"},
    {cat:"C", q:"( ) go to the library.", opts:["Let's","Do","Are","Is"], ans:0, s:"ğŸ›ï¸"},
    {cat:"C", q:"I am ( ) music now.", opts:["listen","listening","listens","listened"], ans:1, s:"ğŸ§"},
    {cat:"C", q:"I am ( ) from Canada.", opts:["no","not","don't","isn't"], ans:1, s:"ğŸ‡¨ğŸ‡¦"},
    {cat:"C", q:"( ) close the door.", opts:["Not","No","Don't","Doesn't"], ans:2, s:"ğŸšª"},
    {cat:"D", q:"Can you ( ) the piano?", opts:["plays","playing","play","played"], ans:2, s:"ğŸ¹"},
    {cat:"D", q:"This is ( ) notebook.", opts:["my","me","I","mine"], ans:0, s:"ğŸ““"},
    {cat:"D", q:"I like ( ) very much.", opts:["apple","an apple","apples","the apple"], ans:2, s:"ğŸ"},
    {cat:"D", q:"( ) name is Ken.", opts:["He","His","Him","He's"], ans:1, s:"ğŸ†”"},
    {cat:"D", q:"Look at ( ).", opts:["we","our","us","ours"], ans:2, s:"ğŸ‘€"},
    {cat:"D", q:"I ( ) like baseball.", opts:["am not","don't","doesn't","not"], ans:1, s:"âš¾"},
    {cat:"D", q:"I ( ) a student.", opts:["is","am","are","be"], ans:1, s:"ğŸ’"},
    {cat:"D", q:"I ( ) a new car.", opts:["want","wants","wanting","to want"], ans:0, s:"ğŸš—"},
    {cat:"D", q:"It is ( ) today.", opts:["sun","sunny","suns","sunned"], ans:1, s:"â˜€ï¸"},
    {cat:"D", q:"This is an ( ).", opts:["pen","book","orange","desk"], ans:2, s:"ğŸŠ"},
    {cat:"D", q:"He ( ) a tall boy.", opts:["am","is","are","do"], ans:1, s:"ğŸ¦’"},
    {cat:"D", q:"That ( ) is mine.", opts:["pen","pens","pen's","a pen"], ans:0, s:"âœ’ï¸"},
    {cat:"D", q:"I like ( ) music.", opts:["listen","listening to","listen to","listens"], ans:1, s:"ğŸµ"},
    {cat:"D", q:"Do you like ( )?", opts:["apple","apples","an apple","the apple"], ans:1, s:"ğŸ"},
    {cat:"D", q:"I have ( ) breakfast.", opts:["a","an","the","(no word)"], ans:3, s:"ğŸ½ï¸"}
];

let quizSet=[], current=0, score=0, wrongAnswers=[], currentMode='', selectedIndex=null;
let soundOn=true, audioCtx=null;

window.onload = displaySavedStamps;

function toggleSound() {
    soundOn = !soundOn;
    document.getElementById("soundBtn").textContent = soundOn ? "ğŸ”Š éŸ³ON" : "ğŸ”‡ éŸ³OFF";
    if(!soundOn) window.speechSynthesis.cancel();
}

function displaySavedStamps() {
    const saved = JSON.parse(localStorage.getItem('eiken5_normal_stamps') || '[]');
    const container = document.getElementById('saved-stamps');
    container.innerHTML = "";
    saved.slice(-10).forEach(s => {
        const div = document.createElement('div');
        div.className = 'stamp'; div.textContent = s; container.appendChild(div);
    });
    document.getElementById('pass-count').textContent = localStorage.getItem('eiken5_pass_count') || '0';
    document.getElementById('perfect-count').textContent = localStorage.getItem('eiken5_perfect_count') || '0';
}

function resetStamps() {
    if(confirm("ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
        localStorage.removeItem('eiken5_normal_stamps');
        localStorage.removeItem('eiken5_pass_count');
        localStorage.removeItem('eiken5_perfect_count');
        displaySavedStamps();
    }
}

function startQuiz(mode) {
    if(!audioCtx) audioCtx = new(window.AudioContext || window.webkitAudioContext)();
    currentMode = mode;
    let filtered = (mode === 'ALL') ? QUESTIONS : QUESTIONS.filter(q => q.cat === mode);
    let num = (mode === 'ALL') ? 10 : 5;
    quizSet = [...filtered].sort(() => 0.5 - Math.random()).slice(0, num);
    current=0; score=0; wrongAnswers=[];
    document.getElementById('view-start').classList.add('hidden');
    document.getElementById('view-quiz').classList.remove('hidden');
    showQuestion();
}

function showQuestion() {
    selectedIndex = null;
    let originalQ = quizSet[current];
    let options = originalQ.opts.map((opt, index) => ({ text: opt, isCorrect: index === originalQ.ans }));
    options.sort(() => 0.5 - Math.random());
    quizSet[current].displayOpts = options.map(o => o.text);
    quizSet[current].displayAns = options.findIndex(o => o.isCorrect);

    document.getElementById('q-header').textContent = `ç¬¬ ${current + 1} å• / ${quizSet.length}`;
    document.getElementById('q-body').textContent = originalQ.q;
    let html = "";
    quizSet[current].displayOpts.forEach((opt, i) => {
        html += `<button class="btn" id="opt${i}" onclick="handleSelect(${i})">${opt}</button>`;
    });
    document.getElementById('options').innerHTML = html;
    speak(originalQ.q);
}

function handleSelect(i) {
    if (selectedIndex === i) {
        submitAnswer(i);
    } else {
        selectedIndex = i;
        document.querySelectorAll('.btn').forEach(b => b.classList.remove('selected'));
        document.getElementById(`opt${i}`).classList.add('selected');
        speak(quizSet[current].displayOpts[i]);
    }
}

function submitAnswer(i) {
    let q = quizSet[current];
    let correct = (i === q.displayAns);
    playSound(correct);
    showMark(correct);
    if(correct) { 
        score++;
        saveNormalStamp(q.s);
    } else { 
        wrongAnswers.push(q); 
    }
    current++;
    setTimeout(() => {
        if(current < quizSet.length) showQuestion();
        else showScore();
    }, 800);
}

function saveNormalStamp(s) {
    let saved = JSON.parse(localStorage.getItem('eiken5_normal_stamps') || '[]');
    if(!saved.includes(s)) {
        saved.push(s);
        localStorage.setItem('eiken5_normal_stamps', JSON.stringify(saved));
    }
}

function showMark(correct) {
    const m = document.getElementById('mark');
    m.textContent = correct ? "â—¯" : "Ã—";
    m.style.color = correct ? "var(--success)" : "var(--wrong)";
    m.className = "mark-ani";
    setTimeout(() => m.className = "", 800);
}

function showScore() {
    document.getElementById('review-area').classList.add('hidden'); // è¡¨ç¤ºãƒªã‚»ãƒƒãƒˆ
    document.getElementById('view-quiz').classList.add('hidden');
    document.getElementById('view-result').classList.remove('hidden');
    document.getElementById('score-text').textContent = `${score} / ${quizSet.length}`;
    
    let msg = document.getElementById('reward-message');
    msg.innerHTML = "";

    if(currentMode === 'ALL') {
        if(score === 10) {
            let count = parseInt(localStorage.getItem('eiken5_perfect_count') || '0') + 1;
            localStorage.setItem('eiken5_perfect_count', count);
            msg.innerHTML = `<p style="color:#fbc02d; font-size:20px;">ğŸ‰ 100ç‚¹ã¾ã‚“ã¦ã‚“ï¼ ğŸ‘‘<br>æº€ç‚¹ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ã‚²ãƒƒãƒˆï¼</p><span style="font-size:60px;">ğŸ‘‘</span>`;
        } else if(score >= 8) {
            let count = parseInt(localStorage.getItem('eiken5_pass_count') || '0') + 1;
            localStorage.setItem('eiken5_pass_count', count);
            msg.innerHTML = `<p style="color:var(--success); font-size:20px;">âœ¨ åˆæ ¼ãŠã‚ã§ã¨ã†ï¼ ğŸ’®<br>åˆæ ¼ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ã‚²ãƒƒãƒˆï¼</p><span style="font-size:60px;">ğŸ’®</span>`;
        }
    }

    const rList = document.getElementById('review-list');
    rList.innerHTML = "";
    if(wrongAnswers.length > 0) {
        document.getElementById('review-area').classList.remove('hidden');
        wrongAnswers.forEach(q => {
            const div = document.createElement('div');
            div.className = 'review-item';
            div.innerHTML = `<span style="color:var(--wrong);font-weight:bold;">${q.q}</span><br><span style="font-size:13px;">ã›ã„ã‹ã„ï¼š${q.opts[q.ans]}</span>`;
            div.onclick = () => speak(q.q.replace("( )", q.opts[q.ans]));
            rList.appendChild(div);
        });
    }
}

function speak(text) {
    if(!soundOn) return;
    window.speechSynthesis.cancel();

    let naturalText = text.includes("( )") 
        ? text.replace("( )", "      ")
        : text;

    // ä½™è¨ˆãªã‚¹ãƒšãƒ¼ã‚¹ã‚’ã¾ã¨ã‚ã¤ã¤ã€ä¸€æ–‡å­—ã® "I" ã¸ã®å¯¾ç­–
    naturalText = naturalText.replace(/\s+/g," ");
    if(naturalText.trim() === "I") {
        naturalText = "I.";
    }

    const u = new SpeechSynthesisUtterance(naturalText);
    u.lang = "en-US";
    u.rate = 0.9;
    u.pitch = 1;
    speechSynthesis.speak(u);
}

function playSound(correct) {
    if(!soundOn || !audioCtx) return;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.frequency.setValueAtTime(correct ? 880 : 220, audioCtx.currentTime);
    gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
    osc.start(); osc.stop(audioCtx.currentTime + 0.3);
}
</script>
</body>
</html>
